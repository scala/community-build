// Note: the Typesafe Config library is a bit picky with suffixes;
// the common files included via the "include" directive should
// have a ".conf" suffix.

// Each project is prefixed by ${vars.base} { ...
// so that common options or settings can be set by the
// configuration that includes this common file.
//
// Note however that += won't work inside vars.base.
// It's https://github.com/typesafehub/config/issues/160.
// That's why if you override extra.commands you must
// explicitly include default-commands.

vars: {
  scala-version                    : ""
  scala-version                    : ${?scala_ref}   // TODO: change param name in jenkins job -- allow overriding scala-version using the scala_version environment variable
  scala-binary-version             : ""
  scala-binary-version             : ${?scala_build_bootstrap_opt} // TODO: change param name in jenkins job
  scala-xml-version                : "1.0.5"
  scala-xml-version                : ${?scala_xml_version}

  // TODO: merge required changes upstream to get rid of our forks, maintaining our one won't scale
  browse-ref                   : "SethTisue/browse.git#topic/2.12-compat"
  lift-framework-ref           : "lift/framework.git#3.0-M2-release"
  spray-ref                    : "spray/spray.git#v1.3.3"
  // only building project twirl-api, fixed sha from master branch that has Scala 2.11 compatibility patches merged
  spray-twirl-ref              : "spray/twirl.git#102978cb508684aee0cfa09d71027965cdcd77b4"
  play-twirl-ref               : "playframework/twirl.git#master"
  play-doc-ref                 : "playframework/play-doc.git#master"
  spray-json-ref               : "spray/spray-json.git"
  // fixed sha from 2.10.x branch that has Scala 2.11 compatibility patches merged
  scala-io-ref                 : "adriaanm/scala-io.git#community-build"
  json4s-ref                   : "json4s/json4s.git#v3.2.10_2.11"
  playframework-ref            : "SethTisue/playframework.git#wip-scala-2.12-mark-ii"
  // fixed sha from master that has Scala 2.11 patches merged
  parboiled-ref                : "sirthias/parboiled.git#c53e650212f222c9b1f75fa1ab13d7cab9db164e"
  // This pull request supports the fully-cross-versioned continuations plugin, shipped with 2.11+
  scala-arm-ref                : "jsuereth/scala-arm.git#pull/31/head"
  genjavadoc-ref               : "typesafehub/genjavadoc.git#v0.5_2.11.0-M8"
  // There's no suitable release yet, so we depend on this commit. Upgrade to the next tagged version once released
  scala-refactoring-ref        : "scala-ide/scala-refactoring.git#44dca8b74808528693f884cfd3c5c9d3ed13e519"
  // "release-0.7" is a stable branch, used to cut 0.7 against new Scala milestones at this time
  scala-stm-ref                : "nbronson/scala-stm.git#release-0.7"
  scalacheck-ref               : "rickynils/scalacheck.git#1.11.6"
  scalatest-ref                : "SethTisue/scalatest.git#3.0.x-community-build"
  spire-ref                    : "SethTisue/spire.git#community-build-2.12"
  shapeless-ref                : "milessabin/shapeless.git"
  scoverage-ref                : "SethTisue/scalac-scoverage-plugin.git#newer-scala-logging"
  kind-projector-ref           : "non/kind-projector.git#v0.7.1"
  sbt-ref                      : "adriaanm/sbt.git#community-build" // 0.13.7-M2 + drop ListBuffer.readOnly (after 0.13.7-M2, new dependencies were added --> TODO: add them here as well)

  // this is commit corresponding to 1.3.0 release, unfortunely pimpathon doesn't tag its releases
  pimpathon-ref                : "stacycurl/pimpathon.git#d2354dd92f5481610f4610edba3574880b07263e"
  sbt-testng-interface-ref     : "SethTisue/sbt-testng-interface.git#no-bintray"

  // forked because minor 2.12 incompat, see https://github.com/scala/community-builds/issues/146
  akka-ref                     : "SethTisue/akka.git#community-build"
  // TODO submit upstream -- extraction fails with JsonMappingException because
  // the ssl-config build overrides `onLoad`, which the dbuild plugin uses to do extraction
  ssl-config-ref               : "SethTisue/ssl-config.git#be-dbuild-friendly"
  fastparse-ref                : "SethTisue/fastparse.git#no-coursier"  // disable sbt-coursier plugin; https://github.com/scala/community-builds/issues/294

  // tracking upstream (the ideal)
  async-ref                    : "scala/async.git"
  breeze-ref                   : "SethTisue/breeze.git#community-build-2.12"  // Scala version checking logic needed tweak
  scala-continuations-ref      : "scala/scala-continuations.git"
  scala-parser-combinators-ref : "scala/scala-parser-combinators.git"
  scala-partest-ref            : "scala/scala-partest.git"
  scala-partest-interface-ref  : "scala/scala-partest-interface.git"
  scala-java8-compat-ref       : "szeiger/scala-java8-compat.git#wip/scala-2.12.0-rc1-compat"
  scala-xml-ref                : "scala/scala-xml.git"
  scala-swing-ref              : "scala/scala-swing.git#2.0.x"
  scala-records-ref            : "scala-records/scala-records.git"
  slick-ref                    : "slick/slick.git"
  twitter-util-ref             : "adriaanm/util.git#develop"
  jawn-ref                     : "non/jawn.git"
  mima-ref                     : "SethTisue/migration-manager.git#2.12-compat"
  utest-ref                    : "lihaoyi/utest.git#0.4.3"
  acyclic-ref                  : "lihaoyi/acyclic.git"
  sourcecode-ref               : "lihaoyi/sourcecode.git"
  macro-paradise-ref           : "adriaanm/paradise.git#2.12.x-cobu"
  macro-compat-ref             : "milessabin/macro-compat.git"
  scala-logging-ref            : "typesafehub/scala-logging.git"
  scalaprops-ref               : "scalaprops/scalaprops.git#0.1.x"  // master uses FreeT from scalaz 7.2, we're on 7.1
  scalikejdbc-ref              : "scalikejdbc/scalikejdbc.git"
  machinist-ref                : "typelevel/machinist.git"

  specs2-3-ref                 : "adriaanm/specs2.git#community-build-3.6" // "etorreborre/specs2.git#SPECS2-3.6.2"
  specs2-2-ref                 : "adriaanm/specs2.git#community-build-2.4" // "etorreborre/specs2.git#SPECS2-2.4.17"

  zinc-ref                     : "typesafehub/zinc.git"
  sbinary-ref                  : "adriaanm/sbinary.git#community-build"

  // TODO move back to master; see https://github.com/scala/community-builds/issues/234
  // for details
  sbt-republish-ref            : "typesafehub/sbt-republish.git#9f7109c705175c6d8e7e99c60e53959f9e4c5df0"

  scalaz-ref                   : "SethTisue/scalaz.git#community-build-2.12"  // TODO SI-8079 fix + variance of Id
  scodec-bits-ref              : "adriaanm/scodec-bits.git#dbuild-sam"
  discipline-ref               : "typelevel/discipline.git#v0.2"
  scala-js-ref                 : "scala-js/scala-js.git"
  scalamock-ref                : "dvic/scalamock.git"  // TODO use paulbutcher/ again once https://github.com/paulbutcher/ScalaMock/pull/149 gets merged
  scalariform-ref              : "daniel-trinh/scalariform.git"

  // master has a "snapshot-0.7a" version setting which makes a picky regex
  // in dbuild 0.9.4 choke; it's https://github.com/typesafehub/dbuild/issues/182.
  // but the problem no longer exists on the 0.8 and 0.9 branches, so
  // once we move to one of those, we won't need the fork anymore.
  scalaz-stream-ref            : "lrytz/scalaz-stream.git#fix-2.12-infer"

  // master depends on Akka HTTP and Akka Stream, which are tricky to depend on
  // (they are built only a special branch). so freeze right before the dependency was added.
  ensime-ref                   : "ensime/ensime-server.git#f4de40f6ce93afa75fd5bbe153c5f1df73035b1a"

  // master uses Shapeless 2.3 only features, so at this time it doesn't make sense to
  // track. there is no other branch we can track, so we use a version tag.  at time of
  // writing (Oct 2015) 1.1.0 is both the latest released version and the version that
  // Ensime depends on.  and Ensime is the main reason we're adding this at all
  spray-json-shapeless-ref     : "fommil/spray-json-shapeless.git#v1.1.0"

  // version settings
  sbt-version                  : "0.13.12"
}

vars {
  // Compiler options from `scalac_opts` env, passed to project builds (not when building scala/scala)
  scalac-opts                  : ""
  scalac-opts                  : ${?scalac_opts}

  default-commands             : []
}

// appendScalacOptions and removeScalacOptions
// let us work around https://github.com/typesafehub/dbuild/issues/144
vars.default-commands += """
set commands ++= {
  def alterScalacOptions(s: State, fn: Seq[String] => Seq[String]): State = {
    val extracted = Project extract s
    import extracted._
    val r = Project.relation(extracted.structure, true)
    val allDefs = r._1s.toSeq
    val projectScope = Load.projectScope(currentRef)
    val scopes = allDefs.filter(_.key == scalacOptions.key).map(_.scope).distinct
    val redefined = scopes.map(scope => scalacOptions in scope <<= (scalacOptions in scope).map(fn))
    val session = extracted.session.appendRaw(redefined)
    BuiltinCommands.reapply(session, structure, s)
  }
  def appendScalacOptions(s: State, args: Seq[String]) = {
    def appendDistinct[A](x: Seq[A], y: Seq[A]) =
      x.filterNot(y.contains) ++ y
    alterScalacOptions(s, appendDistinct(_, args))
  }
  def removeScalacOptions(s: State, args: Seq[String]) =
    alterScalacOptions(s, _.filterNot(args.contains))
  Seq(
    Command.args("appendScalacOptions", "<option>")(appendScalacOptions),
    Command.args("removeScalacOptions", "<option>")(removeScalacOptions))
}
"""
vars.default-commands += "appendScalacOptions "${vars.scalac-opts}
vars.base.extra.commands = ${vars.default-commands}

vars.ivyPat: ", [organisation]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[type]s/[artifact](-[classifier]).[ext]"
options.resolvers: {
  01: "local"

  02: "dbuild: https://scala-ci.typesafe.com/artifactory/dbuild/"
  03: "dbuild-ivy: https://scala-ci.typesafe.com/artifactory/dbuild-ivy/"${vars.ivyPat}
  04: "dbuild-unchecked: https://scala-ci.typesafe.com/artifactory/dbuild-unchecked/" // for sbt plugins not available on ivy (they'll fail the pom check on the `dbuild` cache repo above)

  05: "scala-pr-validation-snapshots: https://scala-ci.typesafe.com/artifactory/scala-pr-validation-snapshots"

  // without this Scala.js can't find the Scala library sources. TODO: why? Artifactory config issue?
  20: "private-repo: https://scala-ci.typesafe.com/artifactory/scala-release-temp/"
}

// we don't have enough disk space to keep stuff longer
options.cleanup: {
  extraction: {
    success: 96
    failure: 120
  }
  build: {
    success: 96
    failure: 120
  }
}

// Topological sort of projects:
// No deps: browse, slick, genjavadoc-plugin, scala-js, scala-swing, scala-partest-interface, async, scalacheck, shapeless, scala-java8-compat
//
// *depends* on scalacheck: scalaz, sbinary, scala-partest, scalatest
// *depends* on scalatest: scodec-bits, scala-records, genjavadoc, scala-stm
//
// scalaz-stream depends on: scalacheck, scalatest, scalaz, scodec-bits

build += {
  check-missing: [ true, false ]
  cross-version: [ disabled, standard ]
  space.from: default
  space.to: [ default, specs2_36, specs2_24 ]
  extraction-version: ${vars.scala-version}
  sbt-version: ${vars.sbt-version}

  projects: [

  ${vars.base} {
    name: "scala-partest-interface"
    uri: "https://github.com/"${vars.scala-partest-interface-ref}
  }

  ${vars.base} {
    name: "scala-partest"
    uri: "https://github.com/"${vars.scala-partest-ref}
  }

  ${vars.base} {
    name: "scala-swing"
    uri: "https://github.com/"${vars.scala-swing-ref}
  }

  ${vars.base} {
    name: "scala-parser-combinators"
    uri: "https://github.com/"${vars.scala-parser-combinators-ref}
    extra.exclude: ["scala-parser-combinatorsJS"]
  }

  ${vars.base} {
    name: scalacheck
    uri: "https://github.com/"${vars.scalacheck-ref}
    extra.run-tests: false   // TODO: is this needed? if yes, document why, if no, re-enable
  }

  ${vars.base} {
    name: scala-stm
    uri:    "https://github.com/"${vars.scala-stm-ref}
    // a minor incompatibility with recent versions of scalatest, therefore:
    extra.run-tests: false // TODO enable tests
  }

  ${vars.base} {
    name: shapeless
    uri:    "https://github.com/"${vars.shapeless-ref}
    extra.projects: ["coreJVM"]
    // optimizer related. Lukas may want to revisit before 2.12 final
    extra.commands: ${vars.default-commands} [ "removeScalacOptions -Xfatal-warnings" ]
    extra.run-tests: false // TODO enable tests
  }

  ${vars.base} {
    name: "scoverage"
    uri:  "https://github.com/"${vars.scoverage-ref}
    extra: ${vars.base.extra} {
      exclude: ["scalac-scoverage-runtimeJS"] // no Scala.js please
      run-tests: false // TODO: [info] java.io.FileNotFoundException: Could not locate [~/.ivy2/cache/org.scala-lang/scala-compiler/jars/scala-compiler-2.11.0.jar].
    }
  }

  ${vars.base} {
    name: "scala-java8-compat"
    uri: "https://github.com/"${vars.scala-java8-compat-ref}
    // For some reason dbuild includes test sources in the javadocs, which trips up javadoc because
    // we use "assert" as an identifier there. We disable doc building to avoid that.
    extra.commands: ${vars.default-commands} [ "set publishArtifact in packageDoc := false" ]
  }

  ${vars.base} {
    name: scalaz
    uri: "https://github.com/"${vars.scalaz-ref}
    // [scalaz] [error] Could not run test scalaz.NeedTest: java.lang.AssertionError: false !== true
    extra.run-tests: false // TODO enable tests
  }

  ${vars.base} {
    name: scalaz-stream
    uri: "https://github.com/"${vars.scalaz-stream-ref}
    extra.run-tests: false // TODO enable tests
    // seems to get stuck after [info] + toInputStream.after close read should return -1: OK, proved property.
    // The stack dump looks like this for minutes on end:
    // ```
    // at scalaz.stream.AsyncTopicSpec$$$Lambda$370/1411106347.apply(Unknown Source)
    // at scalaz.stream.Process$class.scalaz$stream$Process$class$$$anonfun$8(Process.scala:61)
    // at scalaz.stream.Process$class$$Lambda$205/214494001.apply(Unknown Source)
    // at scalaz.stream.Process$class.scalaz$stream$Process$class$$$anonfun$13(Process.scala:115)
    // at scalaz.stream.Process$class$$Lambda$240/283752252.apply(Unknown Source)
    // at scalaz.stream.Util$.Try(Util.scala:38)
    // at scalaz.stream.Process$class.scalaz$stream$Process$class$$$anonfun$12(Process.scala:115)
    // at scalaz.stream.Process$class$$Lambda$239/1861849028.apply(Unknown Source)
    // at scalaz.Trampoline$.scalaz$Trampoline$$$anonfun$28(Free.scala:234)
    // at scalaz.Trampoline$$$Lambda$230/516810462.apply(Unknown Source)
    // at scalaz.Free.scalaz$Free$$$anonfun$15(Free.scala:172)
    // at scalaz.Free$$Lambda$221/2004765452.apply(Unknown Source)
    // at scalaz.Free.go2$1(Free.scala:119)
    // at scalaz.Free.go(Free.scala:122)
    // at scalaz.Free.run(Free.scala:172)
    // at scalaz.stream.Process$class.scalaz$stream$Process$class$$$anonfun$9(Process.scala:84)
    // at scalaz.stream.Process$class$$Lambda$237/879163424.apply(Unknown Source)
    // at scalaz.stream.Util$.Try(Util.scala:38)
    // ```
  }

  ${vars.base} {
    name: scodec-bits
    uri: "https://github.com/"${vars.scodec-bits-ref}
    extra: ${vars.base.extra} {
      projects: ["coreJVM"] // TODO: preemptive
      commands: ${vars.default-commands} [
        "set scalacOptions in coreJVM := Seq(\"-opt:l:classpath\", \"-deprecation\", \"-encoding\", \"UTF-8\", \"-feature\", \"-unchecked\", \"-Xlint\", \"-Yno-adapted-args\", \"-Ywarn-dead-code\", \"-Ywarn-numeric-widen\", \"-Ywarn-value-discard\", \"-Xfuture\", \"-Ywarn-unused-import\")"
      ]
      run-tests: false   // TODO: preemptive
    }
  }

  ${vars.base} {
    name: "scala-records"
    uri: "https://github.com/"${vars.scala-records-ref}
    extra.exclude: ["coreJS"]
  }

  ${vars.base} {
    name: "scalatest"
    uri: "https://github.com/"${vars.scalatest-ref}
    extra: ${vars.base.extra} {
      projects: ["scalatest", "scalactic"]
      run-tests: false // TODO enable tests
    }
  }

  ${vars.base} {
    name:   "genjavadoc-plugin"
    uri:    "https://github.com/"${vars.genjavadoc-ref}
    extra.projects: genjavadoc-plugin
  }

  ${vars.base} {
    name:   "genjavadoc"
    uri:    "https://github.com/"${vars.genjavadoc-ref}
    extra: ${vars.base.extra} {
      projects: ["tests","javaOut"]
      run-tests: false // TODO enable tests
    }
  }

  ${vars.base} {
   name: "akka"
   uri:  "https://github.com/"${vars.akka-ref}
   extra: ${vars.base.extra} {
     options: ["-Dakka.genjavadoc.enabled=false", "-Dakka.scaladoc.diagrams=false", "-Dakka.build.aggregateSamples=false"]
     projects: ["akka-actor"]
     run-tests: false // TODO re-enable tests (they've long been disabled in 2.11 as well) - ST 8/27/15
   }
  }

  ${vars.base} {
    name:   "scala-refactoring"
    uri:    "https://github.com/"${vars.scala-refactoring-ref}
    extra: ${vars.base.extra} {
      directory: "org.scala-refactoring.library"
      run-tests: false // TODO enable tests
    }
  }

  // TODO
  // broken -- does not compile due to source incompat lang change??
  // ${vars.base} {
  //   name:   "scalariform"
  //   uri:    "https://github.com/"${vars.scalariform-ref}
  //   // avoid building misc subproject that depends on Swing (and is not needed by any other project)
  //   extra.projects: ["scalariform"]
  //   extra.run-tests: false
  // }

  ${vars.base} {
    name: "async"
    uri: "https://github.com/"${vars.async-ref}
    extra.run-tests: false // TODO: ToolBox based tests report missing JARs. Probably some poor assumption in the async tests.
  }

  ${vars.base} {
    name: "slick"
    uri:  "https://github.com/"${vars.slick-ref}
    // without this dbuild doesn't pick up that one of the subprojects has this dependency.
    // it doesn't even make sense; it seems to me that testNGSettings should not be adding
    // a dependency of the plugin to the libraryDependencies of the test code.
    // the line in question is:
    //   https://github.com/sbt/sbt-testng-interface/blob/ca730f705f48af2139f39bc726b474afec072738/plugin/src/main/scala/de/johoop/testngplugin/TestNGPlugin.scala#L44
    // I think it's a confusion of levels, but maybe I'm missing something. - ST 8/27/15
    deps.inject: ["de.johoop#sbt-testng-interface"]
    // disable fragile tests (https://github.com/scala/community-builds/issues/12#issuecomment-149941055)
    extra.exclude: ["osgitests"]
  }

  ${vars.base} {
    name: "sbt-testng-interface"
    uri: "https://github.com/"${vars.sbt-testng-interface-ref}
    extra.projects: ["sbt-testng-interface"]  // just the interface, we don't need to build the plugin
  }

 ${vars.base} {
   name:   "browse"
   uri:    "https://github.com/"${vars.browse-ref}
 }

  ${vars.base} {
    name: sbinary
    uri:    "https://github.com/"${vars.sbinary-ref}
    extra: ${vars.base.extra} {
      commands: ${vars.default-commands} [
        "removeScalacOptions -Yinline-warnings"
      ]
    }
  }

  ${vars.base} {
    name:   "scala-js"
    uri:    "http://github.com/"${vars.scala-js-ref}
    extra: ${vars.base.extra} {
      // hopefully avoid intermittent OutOfMemoryErrors with default 1.5G heap?
      options: ["-Xmx2048m"]
      projects: [ tools, testSuite, stubs ]
      commands: ${vars.default-commands} [
        // - Disable compiler/test because it is very fragile.
        "set test in (Build.compiler, Test) := {}"
        // - Disable fatal Scaladoc warnings, also fragile
        "removeScalacOptions -Xfatal-warnings"
        //   We disable source map tests to save ourselves a `npm install source-map-support` on the workers.
        //   Although only `testSuite` actually has tests, dbuild will try to run the tests for all projects
        //   that `testSuite` depends on (transitively), so we need to set it in a bunch of places.
        "set Seq(library, testInterface, jUnitRuntime, testSuite).map(p => jsEnv in p := NodeJSEnv(executable = \"nodejs\").value.withSourceMap(false))"
      ]
    }
  }

  ${vars.base} {
    name:   "utest"
    uri:    "http://github.com/"${vars.utest-ref}
    // no Scala.js plz
    extra.projects: ["utestJVM"]
  }

  ${vars.base} {
    name:   "acyclic"
    uri:    "http://github.com/"${vars.acyclic-ref}
  }

  ${vars.base} {
    name:    "sourcecode"
    uri:     "http://github.com/"${vars.sourcecode-ref}
    // no Scala.js plz
    extra.projects: ["sourcecodeJVM"]
  }

  ${vars.base} {
    name:   "fastparse"
    uri:    "http://github.com/"${vars.fastparse-ref}
    // no Scala.js plz
    extra.projects: ["fastparseJVM"]
    extra.run-tests: false // TODO: tests depend on lambda toString looking like e.g `<function1>`
    // with 0.13.11 I got
    // Running "test" in: fastparseJVM
    // Compiling 9 Scala sources to [...]/fastparse/jvm/target/scala-2.11/test-classes...
    // java.lang.IndexOutOfBoundsException: 0
    //   at scala.collection.LinearSeqOptimized$class.apply(LinearSeqOptimized.scala:65)
    //   at scala.collection.immutable.List.apply(List.scala:84)
    //   at xsbt.ExtractAPI.makeParameter$1(ExtractAPI.scala:295)
    // the issue is reproducible outside of the community build, so it's apparently
    // an sbt regression. reported at https://github.com/sbt/sbt/issues/2497
    extra.sbt-version: "0.13.9"
  }

  ${vars.base} {
    name:   "macro-paradise"
    uri:    "http://github.com/"${vars.macro-paradise-ref}
    extra.run-tests: false // see https://github.com/scala/scala-dev/issues/203
  }

  ${vars.base} {
    name:   "macro-compat"
    uri:    "http://github.com/"${vars.macro-compat-ref}
    // no Scala.js plz
    extra.projects: ["testJVM"]
  }

  ${vars.base} {
    name:   "scala-logging"
    uri:    "http://github.com/"${vars.scala-logging-ref}
  }

  ${vars.base} {
    name:   "scalaprops"
    uri:    "http://github.com/"${vars.scalaprops-ref}
    // will be needed if we start tracking master. not needed on 0.1.x branch
    // extra.projects: ["rootJVM"]  // no Scala.js please
  }

]
}

// scoverage depends on: scala-logging, scalacheck, scalatest
// specs2 depends on: scalacheck, scalatest, scalaz, scalaz-stream, scodec-bits, shapeless, scoverage
build += {
  check-missing: [ true, false ]
  cross-version: [ disabled, standard ]
  space.from: specs2_24
  space.to: [ specs2_24 ]
  extraction-version: ${vars.scala-version}
  sbt-version: ${vars.sbt-version}
  projects: [

  ${vars.base} {
    name: specs2_24
    uri: "https://github.com/"${vars.specs2-2-ref}
    extra.projects: ["specs2"] // so that it actually publishes org.specs2 % specs2? -- needed to put some random artifacts in the jar: https://github.com/typesafehub/dbuild/issues/173
    extra.run-tests: false // TODO: at least SnippetsTest is failing.
  }

  ${vars.base} {
    name: "discipline"
    uri: "https://github.com/"${vars.discipline-ref}
  }

  ${vars.base} {
    name: "machinist"
    uri: "https://github.com/"${vars.machinist-ref}
    extra.projects: ["machinistJVM"]  // no Scala.js please
  }

  ${vars.base} {
    name: "spire"
    uri: "https://github.com/"${vars.spire-ref}
    // TODO: tests crash with:
    // [info] [error] Could not run test spire.laws.LawTests:
    // java.lang.ClassFormatError: Duplicate method name&signature in class file spire/std/OrderProductInstances$$anon$228
    extra.projects: ["spireJVM"]  // no Scala.js please
    extra.run-tests: false
    // no longer exists in 2.12
    extra.commands: ${vars.default-commands} [
      "removeScalacOptions -Yinline-warnings"
    ]
  }

  ${vars.base} {
    name: "breeze"
    uri: "https://github.com/"${vars.breeze-ref}
    // failing tests reported upstream at https://github.com/scalanlp/breeze/issues/587
    extra.run-tests: false
  }

  // in this space because it depends on scoverage
  ${vars.base} {
    name:   "twitter-util"
    uri:    "http://github.com/"${vars.twitter-util-ref}
    // this isn't really necessary and would pull in a JMH dependency
    extra.exclude: ["util-benchmark"]
    // recommended at https://github.com/twitter/util/issues/173:
    // "We use that when we don't think the tests will be reliable in a ci environment"
    extra.options: ["-DSKIP_FLAKY=true"]
    // TODO tests pass in 2.11.x-jdk8, why not here?
    extra.run-tests: false // https://github.com/scala/scala-dev/issues/203#issuecomment-239649902
  }

]}


build += {
  check-missing: [ true, false ]
  cross-version: [ disabled, standard ]
  space.from: specs2_36
  space.to: [ specs2_36 ]
  extraction-version: ${vars.scala-version}
  sbt-version: ${vars.sbt-version}
  projects: [
    ${vars.base} {
      name: kind_projector
      uri:  "https://github.com/"${vars.kind-projector-ref}
      extra: ${vars.base.extra} {
        run-tests: false // TODO: not needed?
      }
    }

    ${vars.base} {
      name: specs2_36
      uri: "https://github.com/"${vars.specs2-3-ref}
      extra.projects: ["specs2"] // so that it actually publishes org.specs2 % specs2? -- needed to put some random artifacts in the jar: https://github.com/typesafehub/dbuild/issues/173
      extra.run-tests: false // TODO: at least SnippetsTest is failing.
    }

    ${vars.base} {
      name: "ssl-config"
      uri: "https://github.com/"${vars.ssl-config-ref}
    }

    ${vars.base} {
      name: "spray-json"
      uri: "https://github.com/"${vars.spray-json-ref}
    }

    // this is separate from "akka" because there is a circular dependency between
    // the akka and ssl-config repos. (akka-http depends on ssl-config-akka which
    // depends on akka-actor)
    ${vars.base} {
      name: "akka-more"
      uri: "https://github.com/"${vars.akka-ref}
      extra: ${vars.base.extra} {
        options: ["-Dakka.genjavadoc.enabled=false", "-Dakka.scaladoc.diagrams=false", "-Dakka.build.aggregateSamples=false"]
        projects: ["akka-scala-nightly"]
        exclude: [
          "akka-docs"   // this is Sphinx stuff, not really apropos here, no Sphinx on Jenkins anyway
          "akka-actor"  // because we already built it in "akka"
          "akka-bench-jmh"  // we'd have to add a resolver to get the JMH dependency - ST 8/17/15
        ]
        run-tests: false  // TODO enable tests
        // Scaladoc generation failure reported upstream at https://github.com/akka/akka/issues/21543
        commands: ${vars.default-commands} [
          "set sources in doc in Compile in httpCore := List()"
        ]
      }
    }

    ${vars.base} {
      name:   "scalikejdbc"
      uri:    "http://github.com/"${vars.scalikejdbc-ref}
      // don't build sbt plugin
      extra.exclude: ["mapper-generator"]
    }

  ]
}


//
// sbt depends on: browse, sbinary, specs2
// sbt-republish depends on: sbt
//
// play-twirl depends on: sbt
// play2-core depends on: akka, play-twirl, scala-stm, specs2 (3.6)
build += {
  check-missing: [ true, false ]
  cross-version: [ disabled, standard ]
  space.from: specs2_36
  space.to: [ play, specs2_36 ]
  extraction-version: ${vars.scala-version}
  sbt-version: ${vars.sbt-version}
  projects: [

// TODO upgrade to latest
// stuck on 0.13.7-M2 because we'll need to add more dependencies to upgrade
// [sbt] [error] **** Missing dependency: the library org.scala-sbt#serialization is not provided (in space "default") by any project in this configuration file.
// [sbt] [error] In order to control which version is used, please add the corresponding project to the build file
// [sbt] [error] (or use "check-missing:false" to ignore (not recommended)).
  // ${vars.base} {
  //  name:   "sbt"
  //  uri:    "https://github.com/"${vars.sbt-ref}
  //  extra: ${vars.base.extra} {
  //    run-tests: false // TODO enable tests
  //    commands: ${vars.default-commands} [
  //      "set every javaVersionPrefix in javaVersionCheck := Some(\"1.8\")"
  //    ]
  //    exclude: ["root","launch-test"]
  //  }
  // }

// TODO: update to current sbt version?? what is it for anyway? (IDE?)
// ${vars.base} {
//   name:   "sbt-republish"
//   uri:    "http://github.com/"${vars.sbt-republish-ref}
//   space: default // We don't compile plugins, for 0.12/2.9.x
// }

  ${vars.base} {
    name:   "zinc"
    uri:    "https://github.com/"${vars.zinc-ref}
    // with 0.13.9 I got
    // project/Scriptit.scala:56: method distinctParser in object Defaults cannot be accessed in object sbt.Defaults
    extra.sbt-version: "0.13.8"
  }

  ${vars.base} {
    name: "play-twirl"
    extra.exclude: [ "plugin", "apiJS" ]
    uri: "https://github.com/"${vars.play-twirl-ref}
  }

  ${vars.base} {
    name: "play-doc"
    uri: "https://github.com/"${vars.play-doc-ref}
  }

  ${vars.base} {
    name: "play2-core"
    uri: "https://github.com/"${vars.playframework-ref}
    extra: ${vars.base.extra} {
      projects: ["Play"]
      exclude: ["SBT-Plugin"]
      directory: "framework"
      run-tests: false // TODO enable tests
      commands: ${vars.default-commands} [
        // workaround for the problem with PlayVersion.scala file is being passed twice to Scala compiler
        // and we get double definition error
        "set sources in (PlayProject, Compile, compile) := (sources in (PlayProject, Compile, compile)).value.distinct"
        // there was some Scaladoc error here I didn't bother to look into
        "set sources in doc in Compile in PlayProject := List()"
      ]
    }
  }

]}


// no deps: json4s
//
// parboiled depends on: scalatest
//
// pimpathon depends on: scala-logging-slf4j, scalacheck, scalatest, scalaz, scoverage
// *depends* on specs2 (3.6): lift-json
//
// spray depends on: Play2-core, json4s, lift-json, parboiled, spray-json, spray-twirl
//
// *depends* on specs2 (2.4): scalamock, spray-twirl, discipline, spray-json
//
// ensime depends on: spray, slick, scoverage, scalamock, pimpathon
build += {
  check-missing: [ true, false ]
  cross-version: [ disabled, standard ]
  space.from: specs2_24
  space.to: [ ensime ]
  extraction-version: ${vars.scala-version}
  sbt-version: ${vars.sbt-version}
  projects: [

  ${vars.base} {
    name: "parboiled"
    uri: "https://github.com/"${vars.parboiled-ref}
    extra: ${vars.base.extra} {
      projects: ["parboiled-scala"]
      // TODO: tests do not compile due to source incompatible change in scalatest
      // TestNGSuite became a class but was a trait
      run-tests: false
    }
  }

  //  TODO: does not compile on java 8
  // ${vars.base} {
  //   name: "json4s"
  //   uri: "https://github.com/"${vars.json4s-ref}
  //   extra.projects: ["json4s-native", "json4s-jackson"]
  // }

  ${vars.base} {
    name: "lift-json"
    uri: "https://github.com/"${vars.lift-framework-ref}
    extra.projects: ["lift-json"]
    // TODO: test failure:
    //[info] [info] ! Either can't be deserialized with type hints
    //[info] [error]  ClassNotFoundException: : scala.util.Left  (Formats.scala:223)
    // !!!: probably we should investigate
    extra.run-tests: false
  }

  ${vars.base} {
    name: "spray-twirl"
    uri: "https://github.com/"${vars.spray-twirl-ref}
    extra.projects: ["twirl-api"]
  }

  ${vars.base} {
    name: "jawn"
    uri: "http://github.com/"${vars.jawn-ref}
    // omitted because currently commented out elsewhere in this file: json4s, spray
    // omitted TODO: play
    // omitted: argonaut, rojoma-v3, rojoma, benchmark
    extra.projects: ["ast", "parser"]
    // no longer exists in 2.12
    extra.commands: ${vars.default-commands} [
      "removeScalacOptions -Yinline-warnings"
    ]
  }

  // note that we don't have MiMa in the JDK6 build.  I tried but it
  // was running out of PermGen when running the functional tests.
  // rather than sink time into investigating, just confining it to
  // JDK8 world seems perfectly fine.
  ${vars.base} {
    name:   "mima"
    uri:    "http://github.com/"${vars.mima-ref}
    // compiling the plugin isn't really necessary as long as sbt remains
    // in Scala 2.10 world, and besides, it was giving "can't expand
    // macros compiled by previous versions of Scala" errors I don't want
    // to take the time to investigate
    extra.exclude: ["sbtplugin"]
  }

  // TODO: stuck on json4s
  // ${vars.base} {
  //   name: "spray"
  //   uri: "https://github.com/"${vars.spray-ref}
  //   extra: ${vars.base.extra} {
  //     // skip tests for now; see https://github.com/scala/community-builds/issues/110
  //     run-tests: false
  //     // disable subprojects depending on shapeless 1
  //     exclude: ["spray-routing", "spray-routing-tests"]
  //     // disable running sphinx, it would be great if dbuild
  //     // oferred a mechanism for excluding particular project (e.g. docs)
  //     commands: ${vars.default-commands} [
  //       "set SphinxSupport.sphinxCompile in docs := Seq.empty"
  //     ]
  //     // disable parallel execution of tests as a work around for non-deterministic
  //     // failures, see: https://github.com/scala/community-builds/pull/69#issuecomment-63324597
  //     settings += "parallelExecution in GlobalScope in Test := false"
  //   }
  // }

  // ${vars.base} {
  //   name:   "pimpathon"
  //   uri:    "https://github.com/"${vars.pimpathon-ref}
  // }

  ${vars.base} {
    name:   "scalamock"
    uri:    "https://github.com/"${vars.scalamock-ref}
    extra.exclude: [ "specs2", "examples" ]
  }

  // TODO: stuck on spray
  // ${vars.base} {
  //   name:   "ensime"
  //   uri:    "https://github.com/"${vars.ensime-ref}
  //   // scaladoc fails with
  //   // [ensime] [info] Compiling 73 Scala sources to .../target/scala-2.11/classes...
  //   // [ensime] [info] Main Scala API documentation to .../target/scala-2.11/api...
  //   // [ensime] [error] .../src/main/scala/org/ensime/indexer/SourceResolver.scala:55: value toMultiMap is not a member of scala.collection.immutable.Set[(org.ensime.indexer.PackageName, org.apache.commons.vfs2.FileObject)]
  //   // [ensime] [error] possible cause: maybe a semicolon is missing before `value toMultiMap'?
  //   // [ensime] [error]   }.toMultiMap[Set]
  //   extra.commands: ${vars.default-commands}
  //     "set every sources in doc in Compile := List()"
  //   ]
  // }

  // TODO: doesn't pick up spray-json dependency, perhaps I'm not understanding
  // the spaces stuff? punting on it since it's only needed for ensime which is
  // commented out right now anyway
  // ${vars.base} {
  //   name:   "spray-json-shapeless"
  //   uri:    "https://github.com/"${vars.spray-json-shapeless-ref}
  // }

]}
