// https://github.com/scalacommunitybuild/lagom.git#community-build-2.13  # was lagom, master

// there are a *ton* of subprojects.  it might be interesting to try to add
// as many as possible. for now, we've somewhat arbitrarily selected a few.

// forked (September 2020) for sbt 1.4 friendliness

vars.proj.lagom: ${vars.base} {
  name: "lagom"
  uri: "https://github.com/scalacommunitybuild/lagom.git#a4811345ecf716e943d6cab4c67b0996a0bf9961"

  // these pull in a number of dependent projects
  extra.projects: ["server", "testkit-scaladsl"]
  extra.exclude: ["kafka-broker-scaladsl"]
  extra.options: [
    // affects unforked tests
    "-Dakka.fail-mixed-versions=false"
    // hopefully avoid intermittent OutOfMemoryErrors with default heap
    "-Xmx2g"
    // needed on sbt 1.3 (and 1.4? not sure) to avoid NoClassDefFoundError after tests run
    "-Dsbt.classloader.close=false"
  ]
  extra.commands: ${vars.default-commands} [
    // affects forked tests
    """set ThisBuild / javaOptions += "-Dakka.fail-mixed-versions=false""""
    // tests in these subprojects are too slow and (more importantly) too fragile
    // "set executeTests in `persistence-cassandra-scaladsl` in Test := Tests.Output(TestResult.Passed, Map(), Iterable())"
    // "set executeTests in `testkit-scaladsl` in Test := Tests.Output(TestResult.Passed, Map(), Iterable())"
    // more flaky tests I haven't reported upstream
    "set Test / unmanagedSources / excludeFilter in `server-scaladsl` := HiddenFileFilter || \"LagomApplicationSpec.scala\""
  ]
  // as usual with scripted-plugin, sigh
  deps.ignore: ["org.scala-sbt#scripted-plugin"]
  check-missing: false
}
