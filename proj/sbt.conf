// https://github.com/eed3si9n/sbt.git#wip/bump_scala   # was sbt, develop

// we have to build this in stages because of circular dependencies
// between repos

vars.proj.sbt-util: ${vars.base} {
  name: "sbt-util"
  uri: "https://github.com/eed3si9n/sbt.git#31f74ae6a6bd073b1e3a7bd9a81ffceefdac6565"

  extra.sbt-version: ${vars.sbt-1-4-version}  // yup, 1.5 is built with 1.4
  extra.projects: ["util*"]
  extra.options: [
    "-Dsbt.scala.version=2.12.11"  // necessary? haven't checked lately
    "-Xmx4G", "-Xss4M",
    "-Dbintray.user=dummy", "-Dbintray.pass=dummy"
  ]
  extra.settings: ${vars.base.extra.settings} [
    "Global / semanticdbEnabled := false"
  ]
  extra.commands: ${vars.default-commands} [
    "set every bintrayReleaseOnPublish := false"
  ]
  check-missing: false  // ignore missing scripted-plugin
}

vars.proj.sbt: ${vars.base} {
  name: "sbt"
  uri: "https://github.com/eed3si9n/sbt.git#31f74ae6a6bd073b1e3a7bd9a81ffceefdac6565"

  extra.sbt-version: ${vars.sbt-1-4-version}  // yup, 1.5 is built with 1.4
  extra.exclude: [
    // built above
    "util*", "collectionProj", "coreMacrosProj"
    // dbuild & sbt-bintray fight (Release.scala calls bintrayRepo.value.upload)
    "bundledLauncherProj"
    // depends on sxr_2.10?!
    "sbtRoot"
    // [sbt:error] java.lang.RuntimeException: You asked dbuild to test using the task "safeUnitTests". The task key exists, but it is undefined in project "vscodePlugin".
    // (fixable I guess, but also seems maybe out-of-scope-ish anyway)
    "vscodePlugin"
  ]
  extra.options: [
    "-Dsbt.scala.version=2.12.11"  // necessary? haven't checked lately
    "-Xmx4G", "-Xss4M",
  ]
  extra.settings: ${vars.base.extra.settings} [
    "Global / semanticdbEnabled := false"
  ]
  extra.commands: ${vars.default-commands} [
    // ParseKey exclusion is as per https://github.com/scala/community-builds/pull/758
    // ParseSpec exclusion is because a test there started consistently failing in July 2019
    """set mainProj/Test/unmanagedSources/excludeFilter := HiddenFileFilter || "ParseKey.scala" || "ParseSpec.scala""""
  ]
}
