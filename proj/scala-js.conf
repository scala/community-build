// https://github.com/scala-js/scala-js.git#82a1d5f64f07e164f3c121e7c05708e14bb47425

// 2.12 tracks master; 2.11/2.13 are frozen for now, pending resolution of discussions at:
// * https://github.com/scala/community-build/issues/1009
// * https://github.com/scala-js/scala-js/pull/3805
// (next comment is separate, master vs 0.6.x isn't the issue here)

// if master proves difficult to track, the 0.6.x branch could be
// used instead; see discussion at
// https://github.com/scala/community-builds/issues/506

vars.sjsv: "2_13"

vars.proj.scala-js: ${vars.base} {
  name: "scala-js"
  uri: "https://github.com/scala-js/scala-js.git#82a1d5f64f07e164f3c121e7c05708e14bb47425"

  // 1.3.0-RC4: ScalaJSCrossVersion.scala:34:23: stable identifier required, but sbt.`package`.CrossVersion.Disabled found.
  extra.sbt-version: ${vars.sbt-1-2-version}
  extra.options: [
    "-Dsbt.scala.version=2.12.10" // sbt 1.2 needs this on JDK 13
    // hopefully avoid intermittent OutOfMemoryErrors with default 1.5G heap?
    "-Xmx2048m"
  ]
  // not really sure how this list was arrived at
  extra.projects: [ "logging"${vars.sjsv}, "linker"${vars.sjsv}, "testSuite"${vars.sjsv} ]
  extra.commands: ${vars.default-commands} [
    // - We disable source map tests to save ourselves a `npm install source-map-support` on the workers.
    //   Although only `testSuite` actually has tests, dbuild will try to run the tests for all projects
    //   that `testSuite` depends on (transitively), so we need to set it in a bunch of places.
    "set Seq(library.v"${vars.sjsv}", testInterface.v"${vars.sjsv}", jUnitRuntime.v"${vars.sjsv}", testSuite.v"${vars.sjsv}").map(p => p / jsEnv := new org.scalajs.jsenv.nodejs.NodeJSEnv(org.scalajs.jsenv.nodejs.NodeJSEnv.Config().withExecutable(\""${vars.node}"\").withSourceMap(false)))"
    "set testSuite.v"${vars.sjsv}" / MyScalaJSPlugin.wantSourceMaps := false"
    // Seb says it isn't appropriate to compile or run tests in certain subprojects;
    // see https://github.com/scala-js/scala-js/issues/3680
    "set testInterface.v"${vars.sjsv}" / Test / test := {}"
    "set jUnitRuntime.v"${vars.sjsv}" / Test / test := {}"
    "set testBridge.v"${vars.sjsv}" / Test / test := {}"
    "set jUnitAsyncJS.v"${vars.sjsv}" / Test / test := {}"
  ]
  // as usual with scripted-plugin, sigh
  deps.ignore: ["org.scala-sbt#scripted-plugin"]
  check-missing: false
}
